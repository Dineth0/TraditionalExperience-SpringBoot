<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <style>
        body {
            background-color: #704534;
        }
        .gallery-thumbs{
            max-height: 450px;
        }
        .thumbLeft{
            position: relative;
            margin-bottom: 10px;
        }
        .gallery-thumbs img{
            width: 100%;
            height: 90px;
              border-radius: 10px;
            cursor: pointer;
        }
        .see-moreBTN{
            position: absolute;
            bottom: 0;
            right: 0;
            left: 0;
            top:0;
            background-color: rgba(255,255,255,0.5);
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.1rem;
            border-radius: 10px;
            cursor: pointer;
        }
        .main-image img{
            width: 100%;
            height: 470px;
            object-fit: cover;
            border-radius: 10px;
        }
        .details-card{
            background-color: rgba(255,255,255,0.5);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
        }
        #rightSide{
            position: fixed;
            top:100px;
            right:40px;
            width: 40%;
            z-index: 1000;
            height: fit-content;
        }
        .picker-box{
            border:1px solid #e6e6e6; border-radius:10px; overflow:hidden; background:#fff;
        }
        .picker-cell{
            padding:12px 14px; display:flex; align-items:center; gap:10px; cursor:pointer;
            border-right:1px solid #eee;
        }
        .picker-cell:last-child{ border-right:none; }
        .picker-cell .label{ font-size:12px; color:#666; display:block; }
        .picker-cell .value{ font-weight:600; }
        .btn-primary-viator{ background:#00897b; border-color:#00897b; }
        .btn-primary-viator:hover{ background:#007b6f; border-color:#007b6f; }
        .info-line{ color:#1f7a1f; font-size:14px; }
        .availability-list .slot{ border:1px solid #e7e7e7; border-radius:10px; padding:10px 12px; margin-bottom:8px; background:#fff; }
        .availability-empty{ padding:10px 12px; border-radius:10px; background:#fff3cd; border:1px solid #ffeeba; color:#8a6d3b; }

    </style>
</head>

<body>
<header class="sticky-top" style="background: rgba(71,40,40,0.9); border-bottom: 1px solid #bf8f5f;">
    <nav class="navbar navbar-expand-lg navbar-dark container-fluid">
        <a class="navbar-brand" href="#" style="color: #e2c6a3;">Heritage Portal</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav">
                <li class="nav-item"><a class="nav-link" href="#">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Crafts</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Workshops</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Reviews</a></li>
                <li class="nav-item"><a class="nav-link" href="#">Contact</a></li>
            </ul>
        </div>
    </nav>
</header>
<h2 id="workshopName" style="text-align: center; margin-bottom: 50px;" ></h2>
<div class="container my-5">
    <div class="row g-4">
        <div class="col-md-7">
            <div class="row">
                <div class="col-3 gallery-thumbs" id="thumbGallery"></div>
                <div class="col-9 main-image" id="mainImage">
                    <img src="" alt="">
                </div>
            </div>
            <div class="row" style="color: white">
                <p><strong>Duration:</strong> <span id="workshopDuration"></span></p>
                <p><strong>Language:</strong> <span id="workshopLanguage"></span></p>
                <p><strong>Participants:</strong> <span id="workshopParticipants">less than</span></p>
                <p class="price">Fee: $<span id="workshopFee"></span></p>
                <p><strong>Address:</strong> <span id="workshopAddress"></span></p>
                <p><strong>Times:</strong> <span id="workshopTimes"></span></p>
                <p><strong>Includes:</strong> <span id="workshopIncludes"></span></p>
            </div>
        </div>

        <div class="col-lg-5">
            <div id="rightSide" class="details-card">
                <p class="mb-2 fs-5">
                    From <span id="fees">0</span><span class="text-muted"> per person</span>
                </p>

                <!-- Date & Travelers IU like screenshot -->
                <div class="picker-box d-flex mt-2">
                    <!-- Date cell -->
                    <div class="picker-cell flex-fill" id="dateCell">
                        <div class="w-100">
                            <span class="label">Date</span>
                            <span class="value" id="dateDisplay">Pick a date</span>
                            <input type="date" class="form-control d-none" id="bookingDate">
                        </div>

                    </div>

                    <!-- Travelers cell -->
                    <div class="picker-cell flex-fill" id="participantCell">
                        <div class="w-100">
                            <span class="label">Participants </span>
                            <span class="value" id="participantCountDisplay"></span>
                        </div>
                        <i class="fa-solid fa-angle-down ms-auto"></i>
                    </div>
                </div>

                <button class="btn btn-primary-viator w-100 mt-3" id="checkAvailabilityBtn">
                    Check Availability
                </button>

                <div class="mt-3 p-3 rounded" style="background:#f2fff6; border:1px solid #d9f5e0;">
                    <p class="mb-1 info-line"><i class="fa fa-check-circle"></i> Free cancellation up to 24 hours before</p>
                    <p class="mb-0 info-line"><i class="fa fa-check-circle"></i> Reserve Now and Pay Later</p>
                </div>

                <!-- Availability results -->
                <div class="mt-3" id="availabilityWrap" style="display:none;">
                    <h6 class="mb-2">Available Workshops</h6>
                    <div class="availability-list" id="availabilityList"></div>
                </div>

                <!--                <div class="mt-3 alert alert-warning mb-0">-->
                <!--                    <strong>Book ahead!</strong><br/>On average, this is booked 12 days in advance.-->
                <!--                </div>-->
            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" >
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center">
                <img id="modalImage" src="" class="img-fluid rounded"></img>
            </div>

            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" id="prevBtn">Prev</button>
                <button type="button" class="btn submit-btn" id="nextBtn">Next</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="participantModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-3">
            <h6 class="mb-2">Select up to <span id="maxTotalSpan"></span> participants in total.</h6>

            <div class="d-flex justify-content-between align-items-center my-2">
                <div>
                    <strong>Only over 8 years old</strong><br>
                    <small class="text-muted">Minimum: 0, Maximum: <span id="maxSpan"></span></small>
                </div>
                <div class="d-flex align-items-center">
                    <button class="btn btn-outline-secondary btn-sm" id="Minus"><i class="fa fa-minus"></i></button>
                    <span class="mx-3" id="participantCount">0</span>
                    <button class="btn btn-outline-secondary btn-sm" id="Plus"><i class="fa fa-plus"></i></button>
                </div>
                <div id="alert"></div>
            </div>

            <button class="btn btn-primary-viator w-100 mt-3" id="applyParticipants">Apply</button>
        </div>
    </div>
</div>

<!--//register and book modal-->

<div class="modal fade" id="WorkshopBookModal" tabindex="-1" aria-labelledby="editJobModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="WorkshopBookModalLabel">Edit Job</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="WorkshopBootForm">
                <input type="hidden" id="editItemId" name="itemId">

                <h3 class="form-section-title">Workshop Booking</h3>
                <div class="row">
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label>Enter the email of someone in your group</label>
                            <input class="form-control" type="email" name="email" id="email" required>
                        </div>
                    </div>
                    <div class="col-lg-12">
                        <div class="form-group">
                            <label>Enter The Phone Number of someone in your group.</label>
                            <input type="text" name="number" class="form-control" id="number" rows="5" required></input>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="form-group">
                            <label>Your Country</label>
                            <input type="text" name="country" class="form-control" id="country" rows="5" required></input>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="form-group">
                            <label>Total Fee</label><span class="text-danger font-weight-bold" id="totalFee">*</span>
                        </div>
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary" id="book">Book Now</button>
                </div>


            </form>
        </div>
    </div>
</div>
<script src="js/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allImages = [];
    let currentIndex = 0;

    function openModal(index) {
        currentIndex = index;
        $('#modalImage').attr('src', 'http://localhost:8080/uploads/' + allImages[currentIndex]);
        $('#imageModal').modal('show');
    }
    $(document).ready(function () {
        let params = new URLSearchParams(window.location.search);
        let workshopId = params.get('id');

        if(!workshopId){
            $('body').html('<p class="text-danger text-center">Workshop Not Found</p>')
            return
        }
        let token = localStorage.getItem('authtoken');
        $.ajax({
            url: `http://localhost:8080/api/v1/workshop/getWorkshopById/${workshopId}` ,
            method: 'GET',
            headers: {
                "Authorization": "Bearer " + token
            },
            success: function (response) {
                let workshop = response.data;
                workshopFee = parseFloat(workshop.fee.toString().replace(/[^0-9.]/g, '')) || 0;

                $("#workshopName").text(workshop.title);

                $("#workshopDescription").text(workshop.description);
                $("#workshopDuration").text(workshop.duration);
                $("#workshopLanguage").text(workshop.language);
                $("#workshopFee").text(workshop.fee);
                $("#fees").text(workshop.fee);
                $("#workshopAddress").text(workshop.address);
                $("#workshopTimes").text(workshop.time.join(", "));
                $("#workshopIncludes").text(workshop.include.join(", "));

                if(workshop.image && workshop.image.length > 0){
                    allImages = workshop.image;
                    $('#mainImage img').attr('src',`http://localhost:8080/uploads/${allImages[0]}`);
                    $('#thumbGallery').empty();

                    allImages.slice(0,5).forEach((img, index) => {
                        let thumbHtml = `<div class="thumbLeft">
                                                <img src="http://localhost:8080/uploads/${img}" data-index="${index}" />
                                            </div>`
                        $('#thumbGallery').append(thumbHtml);
                    })

                    if(allImages.length > 5){
                        $('#thumbGallery .thumbLeft:last').append(
                            `<div class="see-moreBTN" id="seeMoreBtn">See More</div>`
                        );
                    }
                    $('#thumbGallery').on('click','img', function () {
                        let idx = $(this).data('index');
                        $('#mainImage img').attr('src', $(this).attr('src'));

                    })
                    $('#thumbGallery').on('click','#seeMoreBtn', function () {
                        openModal(0);

                    })
                    $('#prevBtn').on('click', function () {
                        currentIndex = (currentIndex - 1 + allImages.length) % allImages.length;
                        $("#modalImage").attr("src", "http://localhost:8080/uploads/" + allImages[currentIndex]);

                    })
                    $('#nextBtn').on('click', function () {
                        currentIndex = (currentIndex +1) % allImages.length;
                        $("#modalImage").attr("src", "http://localhost:8080/uploads/" + allImages[currentIndex]);

                    })

                }

            }



        })
        let maxParticipant = 0;
        let currentParticipant = 0;



        $('#participantCell').on('click', function () {
            let params = new URLSearchParams(window.location.search);
            let workshopId = params.get('id');
            let token = localStorage.getItem('authtoken');

            $.ajax({
                url: `http://localhost:8080/api/v1/workshop/getParticipantCount/${workshopId}`,
                method: 'GET',
                headers: {
                    Authorization: 'Bearer ' + token
                },
                success: function (response) {
                     maxParticipant = response.data || 0;
                     currentParticipant =  0;

                    $('#participantCount').html(maxParticipant);
                    $('#participantCountDisplay').text(maxParticipant);
                    $('#maxSpan').text(maxParticipant);
                    $('#maxTotalSpan').text(maxParticipant);
                    $('#participantModal').modal('show');


                },

                error: function (response) {
                    $('#participantCount').html(0);
                    $('#participantCountDisplay').text(0);
                }


            })
        });

        $('#Minus').on('click', function () {
            if(currentParticipant > 0 ){
                currentParticipant--;

                $('#participantCount').text(currentParticipant);
            }

        });
        $('#Plus').on('click', function () {
            if(currentParticipant < maxParticipant){
                currentParticipant++;
                $('#participantCount').text(currentParticipant);
            }else {
                alert("You cannot select more than " + maxParticipants + " participants.");

            }


        });
        $('#applyParticipants').on('click', function () {
            $('#participantCountDisplay').text(currentParticipant);
            $('#participantModal').modal('hide');
            if(currentParticipant === maxParticipant){
                alert("You cannot select more than " + maxParticipant + " participants.");

            }



        })

        $('#dateCell').on('click', function () {
            $('#bookingDate').removeClass('d-none')[0].click();
        });
        $('#bookingDate').on('change', function () {
            let selected = $(this).val();
            if(selected){
                $('#dateDisplay').text(selected);
                $('#bookingDate').addClass('d-none');
            }
        });

        $('#checkAvailabilityBtn').on('click', function (){
            let token = localStorage.getItem('authtoken');
            let params = new URLSearchParams(window.location.search);
            let workshopId = params.get('id');

            let selectedDate = $('#dateDisplay').text();
            let participantCount = $('#participantCountDisplay').text();

            if(!selectedDate){
                Swal.fire({icon:'warning', title:'Please select a date'});
                return;
            }
            if(!participantCount || participantCount === 0){
                Swal.fire({icon:'warning', title:'Please select a Your Member Count'});
                return;
            }
            $.ajax({
                url:`http://localhost:8080/api/v1/workshopRegistration/checkAvailability/${workshopId}?date=${selectedDate}`,
                method:'GET',
                headers: {
                    "Authorization": "Bearer " + token
                },
                success: function (slots) {
                    $('#availabilityWrap').show();
                    $('#availabilityList').empty();

                    if(slots.length === 0){
                        $('#availabilityList').html('<div class="availability-empty">No Times Available for this day</div>')
                        return;
                    }
                    slots.forEach(function (slot) {
                        let isAvailable = slot.available;
                        let btn = `<button class=" btn btn-primary-viator w-100 mb-2 slotBtn"
                                       data-time="${slot.time}" ${isAvailable ? "" : "disabled"}>
                                       ${slot.time} ${isAvailable ? "" : "(Booked)"}
                                    </button>`
                        $('#availabilityList').append(btn);
                    })


                },
                error: function (response) {
                    Swal.fire({icon:'error', title:'Error Checking Available'});
                    return;
                }
            })
        })




    })

</script>
</body>
</html>

