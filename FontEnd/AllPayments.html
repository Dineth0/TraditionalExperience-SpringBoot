<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>$Title$</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      background-color: #433c3b;
      font-family: 'Inter', sans-serif;
      color: #f4e2c6;
      font-size: 10px;

    }

    .form-section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      color: #e0b84b;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(244, 226, 198, 0.4);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-control {
      border: 1px solid #e0b84b;
      background-color: #5a4e4c;
      border-radius: 8px;
      padding: 10px 15px;
      transition: all 0.3s ease;
      color: #ffffff;
    }

    .form-control:focus {
      border-color: #c97b63;
      background-color: #6e5d5a;
      box-shadow: 0 0 8px rgba(224, 184, 75, 0.5);
      outline: none;
      color: #fff;
    }

    .form-control::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .file-input-container label {
      display: block;
      margin-bottom: 5px;
    }

    .file-input-container input[type="file"] {
      display: block;
      margin-top: 5px;
      padding: 6px;
      border-radius: 8px;
      background-color: #5a4e4c;
      border: 1px solid #e0b84b;
      color: #fff;
    }

    .file-input-container p {
      font-size: 13px;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 5px;
    }

    .submit-btn {
      background-color: #e0b84b;
      color: #433c3b;
      border: none;
      border-radius: 8px;
      padding: 12px 25px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .submit-btn:hover {
      background-color: #c97b63;
      color: #fff;
    }
    .modal-content{
      background-color: #32302b;
    }

  </style>
</head>
<body>
<div class="container my-5">
  <div class="card shadow-sm">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Payment List</h4>

      </div>
      <div class="mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Search Payments...">
      </div>
      <div class="table-responsive">
        <table class="table table-striped table-hover">
          <thead class="table-light">
          <tr>
            <th scope="col">Workshop Name</th>
            <th scope="col">User Name</th>
            <th scope="col">Date</th>
            <th scope="col">Payment Method</th>
            <th scope="col">Amount</th>
            <th scope="col">Status</th>

            <!--                        <th scope="col">Item</th>-->
            <!--                        <th scope="col">Instructor</th>-->


          </tr>
          </thead>
          <tbody class="payment-tbody">

          </tbody>
        </table>
      </div>
    </div>
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center" id="ItemPagination">
        <li class="page-item">
          <a class="page-link" href="#" id="prevPage">Previous</a>
        </li>
        <li class="page-item active" aria-current="page">
          <span class="page-link">1</span>
        </li>
        <li class="page-item"><a class="page-link" href="#">2</a></li>


        <li class="page-item">
          <a class="page-link" href="#" id="nextPage">Next</a>
        </li>
      </ul>
    </nav>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="js/Payment.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  $(document).ready(function() {
    let currentPage = 0;
    const pageSize = 2;
    let totalPages = 0;

    loadPaymentsForPage();

    function loadPaymentsForPage() {
      let token = localStorage.getItem("authtoken")
      $.ajax({
        url: `http://localhost:8080/api/v1/payment/paginated?page=${currentPage}&size=${pageSize}`,
        type: 'GET',
        headers: {
          'Authorization': 'Bearer ' + token
        },
        success: function (res) {
          const payments = res || [];
          let rows = "";
          payments.reverse().forEach((payment) => {
            rows += `
                            <tr class="payment-row">
                                <td>${payment.workshopName}</td>
                               <td>${payment.userName}</td>
                                <td>${payment.paymentDate}</td>
                                <td>${payment.paymentMethod}</td>
                                <td>${payment.amount}</td>
                                <td>${payment.status}</td>

                            </tr>
                        `;
          });
          $('.payment-tbody').html(rows);
          loadPaymentPagination();
        },

        error: function(error, xhr){
          // console.log(err);
          // alert("Failed to load Feedback");
          if(xhr.status === 403){
            Swal.fire({
              icon: "error",
              title: "Not Authenticated",
              showConfirmButton: false,
              timer: 2000
            })
            console.log(error)
          }
        }
      });
    }

    function loadPaymentPagination() {
      let token = localStorage.getItem("authtoken")
      $.ajax({
        url: `http://localhost:8080/api/v1/payment/total-pages?size=${pageSize}`,
        method: "GET",
        headers:{
          'Authorization': 'Bearer ' + token
        },
        success: function (tp) {
          totalPages = tp
          let paginationHTML = "";

            paginationHTML += `
                    <li class="page-item ${ currentPage === 0 ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="prevPage" >Previous</a>
                    </li>
                `;

            const windowSize = 3
          let start = currentPage - 1;
            let end = currentPage + 1

          if(start < 0) { start = 0}
          if(end >= totalPages) { end = totalPages - 1}

          if(end - start + 1 < windowSize && totalPages >= windowSize) {
            if(start === 0){
              end = windowSize - 1;
            }else if(end === totalPages - 1){
              start = totalPages - windowSize;
            }
          }
          for(let i = start; i <= end; i++) {
            paginationHTML += `
               <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="goToPage(${i})">${i + 1}</a>
                    </li>
            `
          }
          paginationHTML += `
               <li class="page-item ${ currentPage === totalPages - 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" id="nextPage" >Next</a>
                    </li>
          `


          $('.pagination').html(paginationHTML);
        },
        error: function (xhr) {
          console.error("Error loading pagination:", xhr.responseText);
        }
      });
    }


    window.goToPage = function(page) {
      currentPage = page;
      loadPaymentsForPage();
    }
    $(document).on('click', '#prevPage', function(e) {
      e.preventDefault();
      if (currentPage > 0) goToPage(currentPage - 1);
    });

    $(document).on('click', '#nextPage', function(e) {
      e.preventDefault();
      if (currentPage < totalPages - 1) goToPage(currentPage + 1);
    });
    function searchPayments(){
      let keyword = $('#searchInput').val();
      let token  = localStorage.getItem("authtoken")

      if(keyword.trim() === ''){
        loadPaymentsForPage();
        return;
      }
      $.ajax({
        method: "GET",
        url: `http://localhost:8080/api/v1/payment/search/${encodeURIComponent(keyword)}`,
        headers: token ? { 'Authorization': 'Bearer ' + token } : {},

        success: function (response) {
          let payments = response.data;
          let container = $(".card-container");
          let tbody = $('.payment-tbody');

          tbody.empty();
          container.empty();

          if (!payments || payments.length === 0) {
            container.html('<p>No items added yet</p>');
            return;
          }

          payments.forEach((payment) => {
           let row = `
                            <tr class="payment-row">
                                <td>${payment.workshopName}</td>
                               <td>${payment.userName}</td>
                                <td>${payment.paymentDate}</td>
                                <td>${payment.paymentMethod}</td>
                                <td>${payment.amount}</td>
                                <td>${payment.status}</td>

                            </tr>
                        `;
           tbody.append(row);
          });



        },
        error: function (xhr, status, error) {
          console.log(xhr.responseText);
          alert("Failed to search Bookings!");
        }
      })
    }
    $('#searchInput').on('keyup', function () {
      searchPayments();
    })
  })
</script>
</body>
</html>